{"title":"","slug":"编译替换内核","date":"2024-10-21","updated":"2024-10-21","comments":true,"path":"api/posts/0.json","excerpt":null,"cover":"https://cdn.nlark.com/yuque/0/2024/png/23099406/1711505651016-2898dc83-58dc-4cdd-9dcc-4da5de1762b9.png","covers":["https://cdn.nlark.com/yuque/0/2024/png/23099406/1711505651016-2898dc83-58dc-4cdd-9dcc-4da5de1762b9.png","https://cdn.nlark.com/yuque/0/2024/png/23099406/1711505783689-354da9c1-ac04-4a2b-8dcf-cb8af5ff319f.png"],"content":"<h2 id=\"编译内核\"><a href=\"# 编译内核\" class=\"headerlink\" title=\"编译内核\"></a>编译内核 </h2><p> 安装软件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt install gcc make libncurses5-dev openssl libssl-dev build-essential pkg-config libc6-dev bison flex libelf-dev dwarves bc -y</span><br></pre></td></tr></table></figure>\n\n<p>在 <a href=\"https://mirrors.tuna.tsinghua.edu.cn/kernel/\">https://mirrors.tuna.tsinghua.edu.cn/kernel/</a> 下载源码 <code>wget</code></p>\n<p>解压<code>tar xvzf linux-6.4.tar.gz</code></p>\n<p>修改<code>.config</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp /boot/config-$(uname -r) .config</span><br><span class=\"line\">vim .config</span><br><span class=\"line\">  CONFIG_SYSTEM_TRUSTED_KEYS=&quot;&quot;</span><br><span class=\"line\">  CONFIG_SYSTEM_REVOCATION_KEYS=&quot;&quot;</span><br><span class=\"line\">make menuconfig</span><br></pre></td></tr></table></figure>\n\n<p>编译</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make -j $(nproc)</span><br></pre></td></tr></table></figure>\n\n<p>安装内核模块 (通过设置 <code>INSTALL_MOD_STRIP=1</code>，可以在安装内核模块时去除不必要的符号信息，减小模块大小)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo make INSTALL_MOD_STRIP=1 modules_install -j $(nproc)</span><br></pre></td></tr></table></figure>\n\n<p>安装内核<code>boot.img</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo make install</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"替换内核\"><a href=\"# 替换内核\" class=\"headerlink\" title=\"替换内核\"></a>替换内核 </h2><p> 内核编译完成后，默认启用 <code>menuentry</code> 第一项，如果要修改为指定版本：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /boot/grub/grub.cfg | grep menuentry</span><br></pre></td></tr></table></figure>\n\n<p>找到要更换的内核名字：</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/23099406/1711505651016-2898dc83-58dc-4cdd-9dcc-4da5de1762b9.png\" alt=\"img\"></p>\n<p>修改<code>GRUB_DEFAULT</code> 为刚刚复制的内核名字：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/default/grub</span><br></pre></td></tr></table></figure>\n\n<p>提示要用更新的名字：</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/23099406/1711505783689-354da9c1-ac04-4a2b-8dcf-cb8af5ff319f.png\" alt=\"img\"></p>\n<p>将 <code>GRUB_DEFAULT</code> 替换为上述名字，执行：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo update-grub</span><br><span class=\"line\">sudo update-grub2</span><br></pre></td></tr></table></figure>\n\n<p>重启，<code>uname -r</code>显示为新内核</p>\n<h2 id=\"删除内核相关文件\"><a href=\"# 删除内核相关文件\" class=\"headerlink\" title=\"删除内核相关文件\"></a>删除内核相关文件</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">find /boot/vm*</span><br><span class=\"line\">rm -rf /boot</span><br><span class=\"line\">rm -rf /lib/modules</span><br><span class=\"line\"></span><br><span class=\"line\">update-grub</span><br><span class=\"line\">update-grub2</span><br><span class=\"line\">make mrproper</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"etc-default-grub 参数\"><a href=\"#etc-default-grub 参数\" class=\"headerlink\" title=\"&#x2F;etc&#x2F;default&#x2F;grub 参数\"></a>&#x2F;etc&#x2F;default&#x2F;grub 参数 </h2><p> 开机显不显示选择内核界面：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GRUB_TIMEOUT_STYLE=hidden  </span><br><span class=\"line\">GRUB_TIMEOUT=10</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"创建 USB 启动盘\"><a href=\"# 创建 USB 启动盘\" class=\"headerlink\" title=\"创建 USB 启动盘\"></a>创建 USB 启动盘</h2><p><a href=\"https://rufus.ie/zh/\">Rufus</a></p>\n","url":"/posts/0/","min2read":1,"word4post":279,"prev_post":null,"next_post":{"title":"Hello World","url":"/posts/16107/"},"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"编译内核\" href = \"#\"><span class=\"toc-number\">1.</span> <span class=\"toc-text\">编译内核 </span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"替换内核\" href = \"#\"><span class=\"toc-number\">2.</span> <span class=\"toc-text\">替换内核 </span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"删除内核相关文件\" href = \"#\"><span class=\"toc-number\">3.</span> <span class=\"toc-text\">删除内核相关文件</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"etc-default-grub 参数\" href = \"#\"><span class=\"toc-number\">4.</span> <span class=\"toc-text\">&#x2F;etc&#x2F;default&#x2F;grub 参数 </span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"创建 USB 启动盘\" href = \"#\"><span class=\"toc-number\">5.</span> <span class=\"toc-text\">创建 USB 启动盘</span></a></li></ol>","categories":[],"tags":[]}